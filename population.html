<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Population Information - T2D SNP Explorer</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/chart.js"></script>
</head>

<body>
    <header>
        <h1>Population Information for: <span id="populationName"></span></h1>
        <script>
            // Extract population name from URL path (e.g., /population/SA)
            const populationName = window.location.pathname.split("/").pop();
            document.getElementById("populationName").textContent = populationName || "Unknown";
        </script>        
    </header>

    <main>
        <section id="populationDetails">
            <h2>Population Details for {{ population_name }} SNP data</h2>
        
            {% if population_info %}
                <p><strong>Geographical Sampling Locations:</strong> {{ population_info.geographical_sampling }}</p>
                <p><strong>Genetic Diversity & Relatedness:</strong> {{ population_info.genetic_diversity }}</p>
                <p><strong>Disease & Trait Associations:</strong> {{ population_info.disease_traits }}</p>
            {% else %}
                <p>No details available for this population.</p>
            {% endif %}
        </section>
        
        {% if sub_populations %}
        
        <section id="subPopulationDetails">
            <h2>Sub-population Information</h2>
            <table>
                <thead>
                    <tr>
                        <th>Sub-population(s)</th>
                        <th>Genetic Diversity</th>
                        <th>Disease & Trait Associations</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in sub_populations %}
                    <tr>
                        <td>{{ sub.sub_population }}</td>
                        <td>{{ sub.genetic_diversity }}</td>
                        <td>{{ sub.disease_traits }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        {% endif %}      
        
        <br>
        <section id="populationStatistics">
            <h2>Summary Statistics of Positive Selection: </h2>

            <h3>FST Values</h3>
            <h4>Overall Stats:</h4>
            <p>Overall Mean FST Score:</p>
            <p>Overall FST Standard Deviation:</p>

            <h4>Sub-Population specific Stats:</h4>
            <label for="fstPopulationCompare">Select Population Comparison:</label>
            <select id="fstPopulationCompare">
                <option value="">-- Select Population --</option>
                <script>
                    const allowedPopulations = ["SA", "EU"];
                    console.log("Current Population Page:", populationName); // Debugging step

                    if (allowedPopulations.includes(populationName)) {
                        document.write('<option value="fst_GIHvsGBR">GIH vs GBR</option>');
                    }
                </script>
            </select>

            <label for="fstChromosomeSelect">Select Chromosome:</label>
            <select id="fstChromosomeSelect" disabled>
                <option value="">-- Select Chromosome --</option>
            </select>

            <!-- Scrollable table container -->
            <div id="fstTableContainer">
                <table id="fstTable">
                    <thead>
                        <tr>
                            <th>Chromosome</th>
                            <th>Position</th>
                            <th>SNP</th>
                            <th>FST</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3>IHS Values</h3>
            <h4>Overall Stats:</h4>
            <p>Overall Mean iHS Score:</p>
            <p>Overall iHS Standard Deviation:</p>
            
            <h4>Sub-Population Specific Stats:</h4>
            <label for="ihsChromosomeSelect">Select Chromosome:</label>
            <select id="ihsChromosomeSelect">
                <option value="">-- Select Chromosome --</option>
            </select>

            <label for="ihsSubpopSelect">Select Sub-population:</label>
            <select id="ihsSubpopSelect">
                <option value="">-- Select Sub-population --</option>
            </select>

            <!-- Scrollable table container -->
            <div id="ihsTableContainer">
                <table id="ihsTable">
                    <thead>
                        <tr>
                            <th>Chromosome</th>
                            <th>Position</th>
                            <th>iHS Score</th>
                            <th>Mean iHS</th>
                            <th>Std iHS</th>
                            <th>Population</th>
                        </tr>
                    </thead>
                    <tbody></tbody>               
                </table>
            </div>
            <div class="pagination-controls">
                <button id="prevPage" disabled>Previous</button>
                <button id="nextPage">Next</button>
            </div> 
            <br>
        </section>

        <button id="downloadData">Download Summary Statistics</button>
        <button id="backToResults">Back to Results</button>
    </main>

    <footer>
        <p>&copy; 2025 T2D SNP Explorer</p>
    </footer>

    <script type="module" src="/static/ui.js"></script>
    <script>
        document.getElementById("backToResults").addEventListener("click", function () {
            window.history.back();
        });

        document.getElementById("downloadData").addEventListener("click", function () {
            const data = "Sample summary statistics\nMean: X.XX\nStd Dev: X.XX";
            const blob = new Blob([data], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "summary_statistics.txt";
            a.click();
        });

        document.getElementById("fstPopulationCompare").addEventListener("change", function () {
            const selectedComparison = this.value;
            console.log("Selected Population Comparison: ", selectedComparison); // Debugging step

            const chromosomeSelect = document.getElementById("fstChromosomeSelect");
            chromosomeSelect.disabled = selectedComparison === "";

            if (selectedComparison === "fst_GIHvsGBR") {
                fetch(`/get_fst_data?populationComparison=${selectedComparison}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("Fetched Data: ", data); // Debugging step
                        const tableBody = document.querySelector("#fstTable tbody");
                        tableBody.innerHTML = "";
                        data.forEach(row => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.Chromosome}</td>
                                <td>${row.Position}</td>
                                <td>${row.SNP}</td>
                                <td>${row.FST}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    })
                    .catch(error => console.error("Error fetching FST data:", error));
            }
        });

    </script>
</body>
</html>
